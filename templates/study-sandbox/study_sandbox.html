{% extends "layouts/base.html" %}
{% load static %}
{% load filters %}

{% block content %} 
    <section>
        <div class="md:flex md:flex-row md:justify-between md:items-start sm:flex sm:flex-col xs:mt-20">
            <div class="md:order-last sm:order-first justify-end sm:h-[600px]">
                <iframe id="lesson-video" class="w-full md:w-[1000px] md:h-[600px] sm:w-[auto] sm:h-[500px]" src="{{ course.placeholder }}"></iframe>
            </div>
            <div class="flex flex-col bg-white border-black border-[0.5px] w-full z-30 p-4 gap-5">
                <h1 class="font-bold text-2xl">Course content</h1>
                <div class="flex flex-col gap-2">
                    {% for lesson in lessons %}
                    <div class="flex flex-col gap-2 dropdown">
                        <button class="flex flex-col items-start drop-button" onclick="toggleDropdown('{{ lesson.id }}')">
                            <p class="font-bold"">{{ lesson.name }}</p>
                            <p class="text-[14px]">Quantity: {{ lesson.lessons_content.all|length}} | {{ lesson.lessons_content.all|total_duration }} min</p>
                        </button>
                        <div id="dropdown-menu-{{ lesson.id }}" class="gap-1 hidden flex-col border-[#363636] rounded-md p-1 border-2">
                            {% for content in lesson.lessons_content.all %}
                                <div onclick="changeVideo('{{content.video_url}}')" class="hover:bg-[#bbbbbb] rounded-md p-2">
                                    <p>{{ content.name }}</p>
                                    <div class="flex justify-between">
                                        <p>{{ content.duration }} min</p>
                                        {% with lesson_progress=content.lesson_progress.first %}
                                            {% if lesson_progress %}
                                                {% if lesson_progress.watched %}
                                                    <p>Watched</p>
                                                {% else %}
                                                    <a id="lesson-{{ content.id }}" onclick="markAsWatched('{{ content.id }}')">Mark as Watched</a>
                                                {% endif %}
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
    <script>
        function markAsWatched(lessonContentId) {
            fetch(`http://localhost:8000/study-sandbox/mark_lesson_watched/${lessonContentId}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the UI to reflect that the lesson is now watched
                const watchedElement = document.getElementById(`lesson-${lessonContentId}`);
                if (watchedElement) {
                    watchedElement.textContent = "Watched";
                    watchedElement.removeAttribute("onclick");
                    watchedElement.removeAttribute("href");
                } else {
                    console.error("Watched element not found");
                }
            })
            .catch(error => {
                console.error("There has been a problem with your fetch operation: ", error);
            });
        }

        function toggleDropdown(lessonId) {
            var dropdownMenu = document.getElementById('dropdown-menu-' + lessonId);
            dropdownMenu.classList.toggle('hidden');
            dropdownMenu.classList.toggle('flex');
        }

        function changeVideo(videoUrl) {
            var videoIframe = document.getElementById('lesson-video');
            videoIframe.src = videoUrl;
        }
    </script>
{% endblock content %}